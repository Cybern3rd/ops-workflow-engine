---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Activity Feed - ops.workflow-engine.org">
  <main class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white">
    <header class="border-b border-gray-700/50 backdrop-blur-lg bg-gray-900/80 sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="/" class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center hover:scale-110 transition-transform">
            <span class="text-2xl">‚ö°</span>
          </a>
          <div>
            <h1 class="text-xl font-bold">Activity Feed</h1>
            <p class="text-sm text-gray-400">Live log of all task changes</p>
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <a href="/" class="text-gray-300 hover:text-white transition-colors">
            ‚Üê Back to Board
          </a>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <div id="activity-feed">
        <div class="flex items-center justify-center h-64">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    import { api } from '../lib/api';

    let agents: any = {};

    async function loadActivity() {
      try {
        const [activity, agentsList, tasks] = await Promise.all([
          api.getActivity(100),
          api.get('/api/agents'),
          api.getTasks(),
        ]);

        // Build agent lookup
        agents = agentsList.reduce((acc: any, agent: any) => {
          acc[agent.id] = agent;
          return acc;
        }, {});

        // Build task lookup
        const tasksLookup = tasks.reduce((acc: any, task: any) => {
          acc[task.id] = task;
          return acc;
        }, {});

        const container = document.getElementById('activity-feed');
        if (!container) return;

        // Group by date
        const activityByDate = activity.reduce((acc: any, item: any) => {
          const date = new Date(item.timestamp * 1000).toLocaleDateString();
          if (!acc[date]) acc[date] = [];
          acc[date].push(item);
          return acc;
        }, {});

        let html = '';

        Object.entries(activityByDate).forEach(([date, items]: [string, any]) => {
          html += `
            <section class="mb-8">
              <h2 class="text-xl font-bold text-gray-400 mb-4 sticky top-20 bg-gray-900 py-2 border-b border-gray-700">
                üìÖ ${date}
              </h2>
              <div class="space-y-3">
          `;

          items.forEach((item: any) => {
            const agent = agents[item.agent_id];
            const task = tasksLookup[item.task_id];
            const time = new Date(item.timestamp * 1000).toLocaleTimeString();

            html += `
              <div class="bg-gray-800/50 backdrop-blur rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors">
                <div class="flex items-start gap-4">
                  <div class="text-3xl flex-shrink-0">${agent?.emoji || 'üë§'}</div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-baseline gap-2 mb-1">
                      <span class="font-bold text-${agent?.color || 'gray'}-400">${agent?.name || 'Unknown'}</span>
                      <span class="text-gray-500 text-sm">${time}</span>
                      <span class="text-gray-400 text-sm">${getActionText(item.action)}</span>
                    </div>
                    ${task ? `
                      <a href="/tasks/${task.id}" class="text-blue-400 hover:text-blue-300 font-medium block mb-2">
                        ${task.title}
                      </a>
                    ` : ''}
                    ${item.details ? `
                      <div class="text-sm text-gray-400 bg-gray-900/50 rounded p-2 mt-2">
                        <code class="text-xs">${formatDetails(item.details)}</code>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            `;
          });

          html += `</div></section>`;
        });

        container.innerHTML = html;
      } catch (error) {
        console.error('Failed to load activity:', error);
        const container = document.getElementById('activity-feed');
        if (container) {
          container.innerHTML = `
            <div class="text-center text-red-400">
              <p class="text-xl mb-2">‚ùå Failed to load activity</p>
              <p class="text-sm">${(error as Error).message}</p>
            </div>
          `;
        }
      }
    }

    function getActionText(action: string): string {
      switch (action) {
        case 'created': return '‚ú® created';
        case 'updated': return 'üìù updated';
        case 'deleted': return 'üóëÔ∏è deleted';
        case 'comment_added': return 'üí¨ commented on';
        case 'document_uploaded': return 'üìé uploaded document to';
        case 'status_changed': return 'üîÑ changed status of';
        default: return action;
      }
    }

    function formatDetails(detailsJson: string): string {
      try {
        const details = JSON.parse(detailsJson);
        return Object.entries(details)
          .map(([key, value]) => `${key}: ${value}`)
          .join(', ');
      } catch {
        return detailsJson;
      }
    }

    loadActivity();

    // Auto-refresh every 30 seconds
    setInterval(loadActivity, 30000);
  </script>
</Layout>

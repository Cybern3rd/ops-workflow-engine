---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Timeline - ops.workflow-engine.org">
  <main class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white">
    <header class="border-b border-gray-700/50 backdrop-blur-lg bg-gray-900/80 sticky top-0 z-50">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a href="/" class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center hover:scale-110 transition-transform">
            <span class="text-2xl">âš¡</span>
          </a>
          <div>
            <h1 class="text-xl font-bold">Timeline & Sprints</h1>
            <p class="text-sm text-gray-400">View tasks by date and sprint</p>
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <a href="/" class="text-gray-300 hover:text-white transition-colors">
            â† Back to Board
          </a>
        </div>
      </div>
    </header>

    <div class="container mx-auto px-4 py-8">
      <div id="timeline-view">
        <div class="flex items-center justify-center h-64">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    import { api } from '../lib/api';

    async function loadTimeline() {
      try {
        const [tasks, sprints] = await Promise.all([
          api.getTasks(),
          api.getSprints(),
        ]);

        const container = document.getElementById('timeline-view');
        if (!container) return;

        // Group tasks by sprint
        const tasksBySprint = tasks.reduce((acc: any, task: any) => {
          const sprint = task.sprint || 'Unscheduled';
          if (!acc[sprint]) acc[sprint] = [];
          acc[sprint].push(task);
          return acc;
        }, {});

        // Generate HTML
        let html = '';

        // Active sprints
        const activeSprints = sprints.filter((s: any) => s.status === 'active');
        if (activeSprints.length > 0) {
          html += `<section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
              <span class="text-3xl">ğŸƒ</span> Active Sprints
            </h2>
            <div class="grid gap-6">`;
          
          activeSprints.forEach((sprint: any) => {
            const sprintTasks = tasksBySprint[sprint.name] || [];
            const doneCount = sprintTasks.filter((t: any) => t.status === 'done').length;
            const progress = sprintTasks.length > 0 ? (doneCount / sprintTasks.length) * 100 : 0;

            html += `
              <div class="bg-gray-800/50 backdrop-blur rounded-xl border border-gray-700 p-6">
                <div class="flex items-start justify-between mb-4">
                  <div>
                    <h3 class="text-xl font-bold">${sprint.name}</h3>
                    <p class="text-gray-400 text-sm mt-1">
                      ${sprint.start_date || 'No start'} â†’ ${sprint.end_date || 'No end'}
                    </p>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold">${doneCount}/${sprintTasks.length}</div>
                    <div class="text-sm text-gray-400">Completed</div>
                  </div>
                </div>
                
                <div class="w-full bg-gray-700 rounded-full h-3 mb-4">
                  <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all" style="width: ${progress}%"></div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  ${sprintTasks.map((task: any) => `
                    <a href="/tasks/${task.id}" class="block bg-gray-900/50 rounded-lg p-3 hover:bg-gray-900 transition-colors">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs">${getPriorityEmoji(task.priority)}</span>
                        <span class="text-xs px-2 py-0.5 rounded-full ${getStatusColor(task.status)}">${task.status}</span>
                      </div>
                      <div class="text-sm font-medium line-clamp-2">${task.title}</div>
                    </a>
                  `).join('')}
                </div>
              </div>
            `;
          });

          html += `</div></section>`;
        }

        // Upcoming sprints
        const planningSprints = sprints.filter((s: any) => s.status === 'planning');
        if (planningSprints.length > 0) {
          html += `<section class="mb-12">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
              <span class="text-3xl">ğŸ“‹</span> Planning
            </h2>
            <div class="grid gap-4">`;
          
          planningSprints.forEach((sprint: any) => {
            const sprintTasks = tasksBySprint[sprint.name] || [];
            html += `
              <div class="bg-gray-800/30 backdrop-blur rounded-xl border border-gray-700 p-4">
                <h3 class="text-lg font-bold">${sprint.name}</h3>
                <p class="text-gray-400 text-sm">${sprintTasks.length} tasks planned</p>
              </div>
            `;
          });

          html += `</div></section>`;
        }

        // Unscheduled tasks
        if (tasksBySprint['Unscheduled']?.length > 0) {
          html += `<section>
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
              <span class="text-3xl">ğŸ“¦</span> Unscheduled
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${tasksBySprint['Unscheduled'].map((task: any) => `
                <a href="/tasks/${task.id}" class="block bg-gray-800/50 rounded-lg p-4 hover:bg-gray-800 transition-colors border border-gray-700">
                  <div class="flex items-center gap-2 mb-2">
                    <span>${getPriorityEmoji(task.priority)}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full ${getStatusColor(task.status)}">${task.status}</span>
                  </div>
                  <h3 class="font-medium mb-1">${task.title}</h3>
                  <p class="text-sm text-gray-400 line-clamp-2">${task.description || 'No description'}</p>
                </a>
              `).join('')}
            </div>
          </section>`;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('Failed to load timeline:', error);
        const container = document.getElementById('timeline-view');
        if (container) {
          container.innerHTML = `
            <div class="text-center text-red-400">
              <p class="text-xl mb-2">âŒ Failed to load timeline</p>
              <p class="text-sm">${(error as Error).message}</p>
            </div>
          `;
        }
      }
    }

    function getPriorityEmoji(priority: string): string {
      switch (priority) {
        case 'p1-high': return 'ğŸ”´';
        case 'p2-medium': return 'ğŸŸ¡';
        case 'p3-low': return 'ğŸŸ¢';
        default: return 'âšª';
      }
    }

    function getStatusColor(status: string): string {
      switch (status) {
        case 'to-do': return 'bg-gray-600 text-gray-200';
        case 'in-progress': return 'bg-blue-600 text-blue-100';
        case 'done': return 'bg-green-600 text-green-100';
        case 'blocked': return 'bg-red-600 text-red-100';
        default: return 'bg-gray-600';
      }
    }

    loadTimeline();
  </script>
</Layout>
